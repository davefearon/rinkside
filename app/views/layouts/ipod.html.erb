<!doctype html>

<!--[if lt IE 7 ]> <html lang="en" class="no-js ie6"> <![endif]-->
<!--[if IE 7 ]>    <html lang="en" class="no-js ie7"> <![endif]-->
<!--[if IE 8 ]>    <html lang="en" class="no-js ie8"> <![endif]-->
<!--[if IE 9 ]>    <html lang="en" class="no-js ie9"> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html lang="en" class="no-js"> <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

  <title>Rinkside</title>
  <meta name="description" content="">
  <meta name="author" content="">

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="shortcut icon" href="/favicon.ico">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">

  <script src="/javascripts/libs/modernizr-1.6.min.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery-1.4.2.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/script.js"></script>

  <%= stylesheet_link_tag :all %>
  <% #= javascript_include_tag :defaults %>
  <%= csrf_meta_tag %>

	<script src="http://code.google.com/apis/gears/gears_init.js"></script>
  <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
  <script>
  var geocoder;
  var initialLocation;
  var ottawa = new google.maps.LatLng(45.409056,-75.681725);
  var browserSupportFlag =  new Boolean();
  var map;
  var infowindow = new google.maps.InfoWindow();

  function initialize() {
    var myOptions = {
      zoom: 10,
      mapTypeId: google.maps.MapTypeId.ROADMAP
    };
    map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);

    // Try W3C Geolocation method (Preferred)
    if(navigator.geolocation) {
      browserSupportFlag = true;
      navigator.geolocation.getCurrentPosition(function(position) {
        initialLocation = new google.maps.LatLng(position.coords.latitude,position.coords.longitude);
        contentString = "You are here mofo!";
        map.setCenter(initialLocation);
        infowindow.setContent(contentString);
        infowindow.setPosition(initialLocation);
        infowindow.open(map);
				var marker = new google.maps.Marker({
					map: map,
					position: initialLocation
				});
				fetch_locations();
      }, function() {
        handleNoGeolocation(browserSupportFlag);
      });
    } else if (google.gears) {
      // Try Google Gears Geolocation
      browserSupportFlag = true;
      var geo = google.gears.factory.create('beta.geolocation');
      geo.getCurrentPosition(function(position) {
        initialLocation = new google.maps.LatLng(position.latitude,position.longitude);
        contentString = "Location found using Google Gears";
        map.setCenter(initialLocation);
        infowindow.setContent(contentString);
        infowindow.setPosition(initialLocation);
        infowindow.open(map);
				var marker = new google.maps.Marker({
					map: map,
					position: initialLocation
				});
				fetch_locations();
      }, function() {
        handleNoGeolocation(browserSupportFlag);
      });
    } else {
      // Browser doesn't support Geolocation
      browserSupportFlag = false;
      handleNoGeolocation(browserSupportFlag);
    }
  }

	function fetch_locations()
	{
		var data = { map: 'fetch' };
		var url = "/home/map.json";

		$.ajax({
			type: "POST",
			url: url,
			data: data,
			async: false,
			dataType: 'json',
			success: function(result)
			{
				addresses = result;
				$.each( addresses, function(i, value) {
					if( value.rink.latitude == "" || value.rink.latitude == null )
					{
						codeAddress( value.rink.id, value.rink.address + ", Ontario, Canada" );
					}
					else
					{
						var marker = new google.maps.Marker({
							map: map,
							position: new google.maps.LatLng(value.rink.latitude,value.rink.longitude)
						});
					}
				});
			}
		});
	}

	function codeAddress( id, address )
	{
		geocoder = new google.maps.Geocoder();
		geocoder.geocode({'address':address}, function(results, status){
			if( status == google.maps.GeocoderStatus.OK )
			{
					var data = {
						id: id,
						latitude: results[0].geometry.location.va,
						longitude: results[0].geometry.location.wa
					};
					$.ajax({
						type: "PUT",
						url: "/rinks/" + id,
						data: data,
						async: false,
						dataType: 'json',
						success: function(r)
						{
							console.debug(r);
						}
					});
				var marker = new google.maps.Marker({
				 	map: map,
				 	position: results[0].geometry.location
				});
				return results[0].geometry.location;
			}
			else
			{
				//error getting geocode info
				console.debug(status)
			}
		});
	}

  function handleNoGeolocation(errorFlag) {
    if (errorFlag == true) {
      initialLocation = newyork;
      contentString = "Error: The Geolocation service failed.";
    } else {
      initialLocation = siberia;
      contentString = "Error: Your browser doesn't support geolocation. Are you in Siberia?";
    }
    map.setCenter(initialLocation);
    infowindow.setContent(contentString);
    infowindow.setPosition(initialLocation);
    infowindow.open(map);
		var marker = new google.maps.Marker({
			map: map,
			position: initialLocation
		});
		fetch_locations();
  }
  </script>
</head>

<body onload="initialize()">

iPod
<%= yield %>

 <!--[if lt IE 7 ]>
    <script src="/javascripts/libs/dd_belatedpng.js"></script>
    <script> DD_belatedPNG.fix('img, .png_bg'); </script>
 <![endif]-->

  <!-- TODO: change UA-XXXXX-X -->
  <script>
   var _gaq = [['_setAccount', 'UA-XXXXX-X'], ['_trackPageview']];
   (function(d, t) {
    var g = d.createElement(t),
        s = d.getElementsByTagName(t)[0];
    g.async = true;
    g.src = ('https:' == location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    s.parentNode.insertBefore(g, s);
   })(document, 'script');
  </script>

</body>
</html>